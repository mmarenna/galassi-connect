<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>User Dashboard</title>
</head>
<body>
    <div layout:fragment="content">
        <!-- Header con info del usuario -->
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Panel de Usuario</h1>
            <div class="text-end">
                <h5 class="mb-0 text-primary" th:text="${usuario.name}">Nombre Usuario</h5>
                <small class="text-muted" th:text="'Ref: ' + ${usuario.reference_id}">Ref: 123</small>
            </div>
        </div>

        <!-- Sección de Archivos -->
        <div id="filesSection">
            <div class="card shadow-sm">
                <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-folder2-open me-2"></i> Archivos Disponibles</span>
                    <span class="badge bg-light text-success" id="empresaName">Cargando empresas...</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Nombre del Archivo</th>
                                    <th>Descripción</th>
                                    <th>Tipo</th>
                                    <th>Empresa ID</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="filesTableBody">
                                <tr><td colspan="5" class="text-center py-4"><div class="spinner-border text-primary" role="status"></div></td></tr>
                            </tbody>
                        </table>
                    </div>
                    <div id="noFilesAlert" class="alert alert-info d-none mt-3">
                        No hay archivos disponibles para tus empresas en este momento.
                    </div>
                </div>
            </div>
        </div>

        <!-- ID del usuario inyectado desde el controlador para uso en JS -->
        <input type="hidden" id="currentUserId" th:value="${usuario.id}">

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                loadUserData();
            });

            function loadUserData() {
                const userId = document.getElementById('currentUserId').value;

                // 1. Obtener datos de la empresa (solo para mostrar el nombre en el header de la card)
                fetch(`/api/user/${userId}/empresa`)
                    .then(response => {
                        if (!response.ok) return null; // Puede no tener empresa asignada
                        return response.json();
                    })
                    .then(empresa => {
                        const empresaLabel = document.getElementById('empresaName');
                        if (empresa) {
                            empresaLabel.textContent = empresa.name;
                        } else {
                            empresaLabel.textContent = 'Sin Empresa Asignada';
                            empresaLabel.className = 'badge bg-warning text-dark';
                        }
                        // Cargamos los archivos independientemente
                        loadFiles(userId);
                    })
                    .catch(error => {
                        console.error(error);
                        document.getElementById('empresaName').textContent = 'Error al cargar';
                        loadFiles(userId);
                    });
            }

            function loadFiles(userId) {
                const tableBody = document.getElementById('filesTableBody');
                const noFilesAlert = document.getElementById('noFilesAlert');

                fetch(`/api/user/${userId}/files`)
                    .then(response => response.json())
                    .then(files => {
                        tableBody.innerHTML = ''; // Limpiar spinner

                        if (files.length === 0) {
                            noFilesAlert.classList.remove('d-none');
                            return;
                        }

                        noFilesAlert.classList.add('d-none');

                        files.forEach(file => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td><i class="bi bi-file-earmark-text me-2 text-primary"></i>${file.name}</td>
                                <td>${file.description || '-'}</td>
                                <td><span class="badge bg-secondary">${file.type}</span></td>
                                <td><small class="text-muted">#${file.empresaId}</small></td>
                                <td>
                                    <a href="/api/user/files/${file.id}/download" class="btn btn-sm btn-outline-primary" target="_blank">
                                        <i class="bi bi-download"></i> Descargar
                                    </a>
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    })
                    .catch(error => {
                        console.error('Error cargando archivos:', error);
                        tableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error al cargar los archivos.</td></tr>';
                    });
            }
        </script>
    </div>
</body>
</html>