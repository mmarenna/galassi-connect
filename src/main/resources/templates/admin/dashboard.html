<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/base}">
<head>
    <title>Admin Dashboard</title>
    <style>
        .drop-zone {
            max-width: 100%;
            height: 200px;
            padding: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-family: "Quicksand", sans-serif;
            font-weight: 500;
            font-size: 20px;
            cursor: pointer;
            color: #cccccc;
            border: 4px dashed #009578;
            border-radius: 10px;
        }

        .drop-zone--over {
            border-style: solid;
        }

        .drop-zone__input {
            display: none;
        }

        .drop-zone__thumb {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            overflow: hidden;
            background-color: #cccccc;
            background-size: cover;
            position: relative;
        }

        .drop-zone__thumb::after {
            content: attr(data-label);
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 5px 0;
            color: #ffffff;
            background: rgba(0, 0, 0, 0.75);
            font-size: 14px;
            text-align: center;
        }

        .dashboard-title {
            color: #0f4c81;
            font-weight: 700;
            position: relative;
            display: inline-block;
            padding-bottom: 10px;
        }

        .dashboard-title::after {
            content: '';
            position: absolute;
            width: 60px;
            height: 4px;
            background-color: #00a8cc;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div layout:fragment="content">

        <div class="text-center mb-5">
            <h1 class="dashboard-title"><i class="bi bi-shield-lock me-2"></i>Panel de Administración</h1>
            <p class="text-muted mt-2">Gestión centralizada de la plataforma</p>
            <div class="mt-3">
                <form th:action="@{/logout}" method="post">
                    <button type="submit" class="btn btn-sm btn-outline-danger">Cerrar Sesión</button>
                </form>
            </div>
        </div>

        <!-- Fila 1: Gestión (Carga, Empresas, Usuarios) -->
        <div class="row mb-4">
            <!-- Tarjeta de Carga de Archivos -->
            <div class="col-md-4 mb-4">
                <div class="card h-100 border-primary shadow-sm">
                    <div class="card-header bg-primary text-white">
                        <i class="bi bi-cloud-upload"></i> Gestión de Archivos
                    </div>
                    <div class="card-body text-center">
                        <h5 class="card-title">Cargar Nuevo Archivo</h5>
                        <p class="card-text small text-muted">Subir archivos PDF, Excel, etc. y asignarlos a una empresa.</p>
                        <button type="button" class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#uploadModal">
                            <i class="bi bi-upload me-1"></i> Cargar Archivo
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Gestión de Empresas -->
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3 text-primary"><i class="bi bi-building fs-1"></i></div>
                        <h5 class="card-title">Empresas</h5>
                        <p class="card-text small text-muted">Crear y administrar empresas asociadas.</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createEmpresaModal">
                                <i class="bi bi-plus-circle"></i> Crear
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSection('empresas')">
                                <i class="bi bi-list-ul"></i> Listar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tarjeta de Gestión de Usuarios -->
            <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm">
                    <div class="card-body text-center">
                        <div class="mb-3 text-primary"><i class="bi bi-people fs-1"></i></div>
                        <h5 class="card-title">Usuarios</h5>
                        <p class="card-text small text-muted">Administrar usuarios y accesos.</p>
                        <div class="d-grid gap-2">
                            <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#createUsuarioModal">
                                <i class="bi bi-person-plus"></i> Crear
                            </button>
                            <button class="btn btn-outline-secondary" onclick="showSection('usuarios')">
                                <i class="bi bi-people"></i> Listar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fila 2: Auditoría -->
        <div class="row mb-5 justify-content-center">
            <!-- Auditoría de Usuarios -->
            <div class="col-md-5 mb-4">
                <div class="card h-100 border-info shadow-sm">
                    <div class="card-header bg-info text-white">
                        <i class="bi bi-search"></i> Auditoría de Usuarios
                    </div>
                    <div class="card-body text-center">
                        <h5 class="card-title">Ver Archivos de Usuario</h5>
                        <p class="card-text small text-muted">Inspeccionar qué archivos ve un cliente específico.</p>
                        <div class="input-group">
                            <select class="form-select" id="auditUserSelect">
                                <option value="" selected disabled>Seleccione un Usuario...</option>
                                <th:block th:each="usuario : ${usuarios}">
                                    <option th:value="${usuario.id}" th:text="${usuario.name} + ' (Ref: ' + ${usuario.reference_id} + ')'"></option>
                                </th:block>
                            </select>
                            <button class="btn btn-info text-white" type="button" onclick="viewUserFiles()">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Auditoría de Empresas -->
            <div class="col-md-5 mb-4">
                <div class="card h-100 border-warning shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <i class="bi bi-building-check"></i> Auditoría de Empresas
                    </div>
                    <div class="card-body text-center">
                        <h5 class="card-title">Ver Archivos de Empresa</h5>
                        <p class="card-text small text-muted">Listar y eliminar archivos asignados a una empresa.</p>
                        <div class="input-group">
                            <select class="form-select" id="auditEmpresaSelect">
                                <option value="" selected disabled>Seleccione una Empresa...</option>
                                <th:block th:each="empresa : ${empresas}">
                                    <option th:value="${empresa.id}" th:text="${empresa.name} + ' (Ref: ' + ${empresa.reference_id} + ')'"></option>
                                </th:block>
                            </select>
                            <button class="btn btn-warning" type="button" onclick="viewEmpresaFiles()">
                                <i class="bi bi-eye"></i> Ver
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECCIÓN DE TABLAS (PAGINADAS) -->
        <div id="dataSection" class="card shadow d-none mb-5">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0 text-primary fw-bold" id="sectionTitle">Listado</h5>
                <button class="btn btn-sm btn-close" onclick="hideSection()"></button>
            </div>
            <div class="card-body">
                <!-- Tabla Empresas -->
                <div id="empresasTableContainer" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Ref ID</th>
                                    <th>CUIT</th>
                                    <th>Email</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="empresasTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="empresasPagination"></ul>
                    </nav>
                </div>

                <!-- Tabla Usuarios -->
                <div id="usuariosTableContainer" class="d-none">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Nombre</th>
                                    <th>Ref ID</th>
                                    <th>Email</th>
                                    <th>Empresas</th>
                                    <th>Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usuariosTableBody"></tbody>
                        </table>
                    </div>
                    <nav aria-label="Page navigation" class="mt-3">
                        <ul class="pagination justify-content-center" id="usuariosPagination"></ul>
                    </nav>
                </div>
            </div>
        </div>

        <!-- ================= MODALES ================= -->

        <!-- Modal Gestión de Acceso -->
        <div class="modal fade" id="manageAccessModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-dark text-white">
                        <h5 class="modal-title">Gestionar Acceso</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="accessForm">
                            <input type="hidden" id="accessUserId">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Usuario (Login)</label>
                                <input type="text" class="form-control" id="accessUsername" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Contraseña</label>
                                <input type="password" class="form-control" id="accessPassword" required placeholder="Nueva contraseña">
                            </div>
                            <div id="accessStatus" class="alert alert-info d-none"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="saveAccess()">Guardar Credenciales</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Auditoría de Archivos Usuario -->
        <div class="modal fade" id="auditFilesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-info text-white">
                        <h5 class="modal-title">Archivos del Usuario</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Archivo</th>
                                        <th>Descripción</th>
                                        <th>Tipo</th>
                                        <th>Empresa ID</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="auditFilesTableBody"></tbody>
                            </table>
                        </div>
                        <div id="auditNoFilesAlert" class="alert alert-warning d-none">Este usuario no tiene archivos visibles.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Auditoría de Archivos Empresa -->
        <div class="modal fade" id="auditEmpresaFilesModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-warning text-dark">
                        <h5 class="modal-title">Archivos de la Empresa</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Archivo</th>
                                        <th>Descripción</th>
                                        <th>Tipo</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="auditEmpresaFilesTableBody"></tbody>
                            </table>
                        </div>
                        <div id="auditEmpresaNoFilesAlert" class="alert alert-warning d-none">Esta empresa no tiene archivos cargados.</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Carga de Archivos -->
        <div class="modal fade" id="uploadModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Cargar Archivo a Empresa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="uploadForm">
                            <div class="mb-3">
                                <label for="empresaSelect" class="form-label fw-bold">Empresa</label>
                                <select class="form-select" id="empresaSelect" required>
                                    <option value="" selected disabled>Seleccione una empresa...</option>
                                    <th:block th:each="empresa : ${empresas}">
                                        <option th:value="${empresa.id}" th:text="${empresa.name} + ' (Ref: ' + ${empresa.reference_id} + ')'"></option>
                                    </th:block>
                                </select>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="fileDescription" class="form-label fw-bold">Descripción</label>
                                    <input type="text" class="form-control" id="fileDescription" required placeholder="Ej: Factura Enero">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="fileType" class="form-label fw-bold">Tipo de Documento</label>
                                    <select class="form-select" id="fileType" required>
                                        <option value="Lista de Precios">Lista de Precios</option>
                                        <option value="Paletizado">Paletizado</option>
                                        <option value="Catalogo">Catalogo</option>
                                        <option value="Vario temporal">Vario temporal</option> <!-- NUEVA OPCIÓN -->
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Archivo</label>
                                <div class="drop-zone">
                                    <span class="drop-zone__prompt">Arrastra el archivo aquí o haz clic para subir</span>
                                    <input type="file" name="file" class="drop-zone__input" id="fileInput" required>
                                </div>
                            </div>
                            <div id="uploadAlert" class="alert d-none" role="alert"></div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-primary" onclick="uploadFile()">Subir Archivo</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Crear Empresa -->
        <div class="modal fade" id="createEmpresaModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Nueva Empresa</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createEmpresaForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nombre</label>
                                <input type="text" class="form-control" id="empresaName" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Reference ID (IDPROVGALASI)</label>
                                <input type="text" class="form-control" id="empresaRefId" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">CUIT</label>
                                    <input type="text" class="form-control" id="empresaCuit">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="email" class="form-control" id="empresaEmail">
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="createEmpresa()">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Crear Usuario -->
        <div class="modal fade" id="createUsuarioModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">Nuevo Usuario</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="createUsuarioForm">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Nombre</label>
                                <input type="text" class="form-control" id="usuarioName" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Reference ID (IdCliente)</label>
                                    <input type="text" class="form-control" id="usuarioRefId" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label fw-bold">Email</label>
                                    <input type="email" class="form-control" id="usuarioEmail">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Empresas Asignadas</label>
                                <select class="form-select" id="usuarioEmpresaSelect" multiple required style="height: 150px;">
                                    <th:block th:each="empresa : ${empresas}">
                                        <option th:value="${empresa.id}" th:text="${empresa.name}"></option>
                                    </th:block>
                                </select>
                                <small class="text-muted">Mantén presionado Ctrl (o Cmd) para seleccionar varias.</small>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="button" class="btn btn-success" onclick="createUsuario()">Guardar</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // --- Variables Globales ---
            let currentEmpresasPage = 0;
            let currentUsuariosPage = 0;
            const pageSize = 10;

            // --- Lógica de UI ---
            function showSection(type) {
                document.getElementById('dataSection').classList.remove('d-none');
                document.getElementById('empresasTableContainer').classList.add('d-none');
                document.getElementById('usuariosTableContainer').classList.add('d-none');

                if (type === 'empresas') {
                    document.getElementById('sectionTitle').textContent = 'Listado de Empresas';
                    document.getElementById('empresasTableContainer').classList.remove('d-none');
                    loadEmpresas(0);
                } else if (type === 'usuarios') {
                    document.getElementById('sectionTitle').textContent = 'Listado de Usuarios';
                    document.getElementById('usuariosTableContainer').classList.remove('d-none');
                    loadUsuarios(0);
                }

                document.getElementById('dataSection').scrollIntoView({ behavior: 'smooth' });
            }

            function hideSection() {
                document.getElementById('dataSection').classList.add('d-none');
            }

            // --- Auditoría de Archivos ---
            function viewUserFiles() {
                const userId = document.getElementById('auditUserSelect').value;
                if (!userId) {
                    Swal.fire('Atención', 'Seleccione un usuario primero', 'warning');
                    return;
                }

                fetch(`/api/admin/usuarios/${userId}/files`)
                    .then(res => res.json())
                    .then(files => {
                        const tbody = document.getElementById('auditFilesTableBody');
                        tbody.innerHTML = '';
                        const alertBox = document.getElementById('auditNoFilesAlert');

                        if (files.length === 0) {
                            alertBox.classList.remove('d-none');
                        } else {
                            alertBox.classList.add('d-none');
                            files.forEach(f => {
                                tbody.innerHTML += `
                                    <tr>
                                        <td>${f.name}</td>
                                        <td>${f.description || '-'}</td>
                                        <td><span class="badge bg-secondary">${f.type}</span></td>
                                        <td>${f.empresaId}</td>
                                        <td>
                                            <a href="/api/user/files/${f.id}/download" class="btn btn-sm btn-outline-primary" target="_blank">
                                                <i class="bi bi-download"></i>
                                            </a>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                        new bootstrap.Modal(document.getElementById('auditFilesModal')).show();
                    });
            }

            // --- Auditoría de Archivos Empresa (NUEVO) ---
            function viewEmpresaFiles() {
                const empresaId = document.getElementById('auditEmpresaSelect').value;
                if (!empresaId) {
                    Swal.fire('Atención', 'Seleccione una empresa primero', 'warning');
                    return;
                }

                fetch(`/api/admin/empresas/${empresaId}/files`)
                    .then(res => res.json())
                    .then(files => {
                        const tbody = document.getElementById('auditEmpresaFilesTableBody');
                        tbody.innerHTML = '';
                        const alertBox = document.getElementById('auditEmpresaNoFilesAlert');

                        if (files.length === 0) {
                            alertBox.classList.remove('d-none');
                        } else {
                            alertBox.classList.add('d-none');
                            files.forEach(f => {
                                tbody.innerHTML += `
                                    <tr>
                                        <td>${f.name}</td>
                                        <td>${f.description || '-'}</td>
                                        <td><span class="badge bg-secondary">${f.type}</span></td>
                                        <td>
                                            <a href="/api/user/files/${f.id}/download" class="btn btn-sm btn-outline-primary me-1" target="_blank" title="Descargar">
                                                <i class="bi bi-download"></i>
                                            </a>
                                            <button class="btn btn-sm btn-danger" onclick="deleteFile(${f.id}, ${empresaId})" title="Eliminar">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                `;
                            });
                        }
                        new bootstrap.Modal(document.getElementById('auditEmpresaFilesModal')).show();
                    });
            }

            function deleteFile(fileId, empresaId) {
                Swal.fire({
                    title: '¿Eliminar archivo?',
                    text: "Esta acción no se puede deshacer",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    confirmButtonText: 'Sí, eliminar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/admin/files/${fileId}`, { method: 'DELETE' })
                            .then(res => {
                                if(res.ok) {
                                    Swal.fire('Eliminado', 'Archivo eliminado', 'success');
                                    viewEmpresaFiles();
                                } else Swal.fire('Error', 'No se pudo eliminar', 'error');
                            });
                    }
                })
            }

            // --- Gestión de Credenciales (NUEVO) ---
            function openAccessModal(userId) {
                document.getElementById('accessUserId').value = userId;
                document.getElementById('accessUsername').value = '';
                document.getElementById('accessPassword').value = '';
                document.getElementById('accessStatus').classList.add('d-none');

                fetch(`/api/admin/usuarios/${userId}/credenciales`)
                    .then(res => res.json())
                    .then(data => {
                        if(data.hasAccess) {
                            document.getElementById('accessUsername').value = data.username;
                            document.getElementById('accessStatus').textContent = 'Este usuario ya tiene acceso. Puedes actualizar la contraseña.';
                            document.getElementById('accessStatus').classList.remove('d-none');
                        }
                        new bootstrap.Modal(document.getElementById('manageAccessModal')).show();
                    });
            }

            function saveAccess() {
                const userId = document.getElementById('accessUserId').value;
                const username = document.getElementById('accessUsername').value;
                const password = document.getElementById('accessPassword').value;

                if(!username || !password) {
                    Swal.fire('Error', 'Usuario y contraseña son obligatorios', 'error');
                    return;
                }

                fetch(`/api/admin/usuarios/${userId}/credenciales`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({username, password})
                }).then(res => {
                    if(res.ok) {
                        Swal.fire('Guardado', 'Credenciales actualizadas correctamente', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('manageAccessModal')).hide();
                    } else {
                        Swal.fire('Error', 'No se pudo guardar. El usuario podría estar duplicado.', 'error');
                    }
                });
            }

            // --- Carga de Empresas (Paginada) ---
            function loadEmpresas(page) {
                currentEmpresasPage = page;
                fetch(`/api/admin/empresas?page=${page}&size=${pageSize}`)
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById('empresasTableBody');
                        tbody.innerHTML = '';
                        data.content.forEach(e => {
                            tbody.innerHTML += `
                                <tr>
                                    <td>${e.id}</td>
                                    <td>${e.name}</td>
                                    <td>${e.reference_id}</td>
                                    <td>${e.cuit || '-'}</td>
                                    <td>${e.email || '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-danger" onclick="deleteEmpresa(${e.id})"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        });
                        renderPagination('empresasPagination', data, loadEmpresas);
                    });
            }

            // --- Carga de Usuarios (Paginada) ---
            function loadUsuarios(page) {
                currentUsuariosPage = page;
                fetch(`/api/admin/usuarios?page=${page}&size=${pageSize}`)
                    .then(res => res.json())
                    .then(data => {
                        const tbody = document.getElementById('usuariosTableBody');
                        tbody.innerHTML = '';
                        data.content.forEach(u => {
                            const empresasCount = u.empresaIds ? u.empresaIds.length : 0;
                            tbody.innerHTML += `
                                <tr>
                                    <td>${u.id}</td>
                                    <td>${u.name}</td>
                                    <td>${u.reference_id}</td>
                                    <td>${u.email || '-'}</td>
                                    <td><span class="badge bg-info text-dark">${empresasCount} Asignadas</span></td>
                                    <td>
                                        <button class="btn btn-sm btn-dark me-1" onclick="openAccessModal(${u.id})" title="Gestionar Acceso"><i class="bi bi-key"></i></button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteUsuario(${u.id})" title="Eliminar"><i class="bi bi-trash"></i></button>
                                    </td>
                                </tr>
                            `;
                        });
                        renderPagination('usuariosPagination', data, loadUsuarios);
                    });
            }

            // --- Renderizado de Paginación ---
            function renderPagination(elementId, pageData, loadFunction) {
                const nav = document.getElementById(elementId);
                nav.innerHTML = '';

                const prevLi = document.createElement('li');
                prevLi.className = `page-item ${pageData.first ? 'disabled' : ''}`;
                prevLi.innerHTML = `<a class="page-link" href="#" onclick="return false;">Anterior</a>`;
                prevLi.onclick = () => { if (!pageData.first) loadFunction(pageData.number - 1); };
                nav.appendChild(prevLi);

                const infoLi = document.createElement('li');
                infoLi.className = 'page-item disabled';
                infoLi.innerHTML = `<span class="page-link">Página ${pageData.number + 1} de ${pageData.totalPages}</span>`;
                nav.appendChild(infoLi);

                const nextLi = document.createElement('li');
                nextLi.className = `page-item ${pageData.last ? 'disabled' : ''}`;
                nextLi.innerHTML = `<a class="page-link" href="#" onclick="return false;">Siguiente</a>`;
                nextLi.onclick = () => { if (!pageData.last) loadFunction(pageData.number + 1); };
                nav.appendChild(nextLi);
            }

            // --- Funciones CRUD ---
            function createEmpresa() {
                const data = {
                    name: document.getElementById('empresaName').value,
                    reference_id: document.getElementById('empresaRefId').value,
                    cuit: document.getElementById('empresaCuit').value,
                    email: document.getElementById('empresaEmail').value
                };
                fetch('/api/admin/empresas', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                }).then(res => {
                    if(res.ok) {
                        Swal.fire('Éxito', 'Empresa creada correctamente', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('createEmpresaModal')).hide();
                        if(!document.getElementById('empresasTableContainer').classList.contains('d-none')) {
                            loadEmpresas(currentEmpresasPage);
                        }
                        location.reload();
                    } else Swal.fire('Error', 'No se pudo crear la empresa', 'error');
                });
            }

            function deleteEmpresa(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "No podrás revertir esto",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/admin/empresas/${id}`, { method: 'DELETE' })
                            .then(res => {
                                if(res.ok) {
                                    Swal.fire('Eliminado', 'La empresa ha sido eliminada.', 'success');
                                    loadEmpresas(currentEmpresasPage);
                                } else Swal.fire('Error', 'No se pudo eliminar', 'error');
                            });
                    }
                })
            }

            function createUsuario() {
                const select = document.getElementById('usuarioEmpresaSelect');
                const selectedEmpresas = Array.from(select.selectedOptions).map(option => parseInt(option.value));

                const data = {
                    name: document.getElementById('usuarioName').value,
                    reference_id: document.getElementById('usuarioRefId').value,
                    email: document.getElementById('usuarioEmail').value,
                    empresaIds: selectedEmpresas
                };
                fetch('/api/admin/usuarios', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                }).then(res => {
                    if(res.ok) {
                        Swal.fire('Éxito', 'Usuario creado correctamente', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('createUsuarioModal')).hide();
                        if(!document.getElementById('usuariosTableContainer').classList.contains('d-none')) {
                            loadUsuarios(currentUsuariosPage);
                        }
                    } else Swal.fire('Error', 'No se pudo crear el usuario', 'error');
                });
            }

            function deleteUsuario(id) {
                Swal.fire({
                    title: '¿Estás seguro?',
                    text: "No podrás revertir esto",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Sí, eliminar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/api/admin/usuarios/${id}`, { method: 'DELETE' })
                            .then(res => {
                                if(res.ok) {
                                    Swal.fire('Eliminado', 'El usuario ha sido eliminado.', 'success');
                                    loadUsuarios(currentUsuariosPage);
                                } else Swal.fire('Error', 'No se pudo eliminar', 'error');
                            });
                    }
                })
            }

            // --- Drag & Drop y Upload ---
            function uploadFile() {
                const empresaId = document.getElementById('empresaSelect').value;
                const description = document.getElementById('fileDescription').value;
                const type = document.getElementById('fileType').value;
                const fileInput = document.getElementById('fileInput');

                if (!empresaId || !description || !type || fileInput.files.length === 0) {
                    Swal.fire('Atención', 'Por favor completa todos los campos', 'warning');
                    return;
                }
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);
                formData.append('description', description);
                formData.append('type', type);

                fetch(`/api/admin/empresas/${empresaId}/files`, { method: 'POST', body: formData })
                .then(res => {
                    if (res.ok) {
                        Swal.fire('Éxito', 'Archivo subido correctamente', 'success');
                        bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
                    } else Swal.fire('Error', 'No se pudo subir el archivo', 'error');
                });
            }

            // Inicialización Drag & Drop
            document.querySelectorAll(".drop-zone__input").forEach((inputElement) => {
                const dropZoneElement = inputElement.closest(".drop-zone");
                dropZoneElement.addEventListener("click", (e) => inputElement.click());
                inputElement.addEventListener("change", (e) => {
                    if (inputElement.files.length) updateThumbnail(dropZoneElement, inputElement.files[0]);
                });
                dropZoneElement.addEventListener("dragover", (e) => { e.preventDefault(); dropZoneElement.classList.add("drop-zone--over"); });
                ["dragleave", "dragend"].forEach((type) => { dropZoneElement.addEventListener(type, (e) => dropZoneElement.classList.remove("drop-zone--over")); });
                dropZoneElement.addEventListener("drop", (e) => {
                    e.preventDefault();
                    if (e.dataTransfer.files.length) {
                        inputElement.files = e.dataTransfer.files;
                        updateThumbnail(dropZoneElement, e.dataTransfer.files[0]);
                    }
                    dropZoneElement.classList.remove("drop-zone--over");
                });
            });
            function updateThumbnail(dropZoneElement, file) {
                let thumbnailElement = dropZoneElement.querySelector(".drop-zone__thumb");
                if (dropZoneElement.querySelector(".drop-zone__prompt")) dropZoneElement.querySelector(".drop-zone__prompt").remove();
                if (!thumbnailElement) {
                    thumbnailElement = document.createElement("div");
                    thumbnailElement.classList.add("drop-zone__thumb");
                    dropZoneElement.appendChild(thumbnailElement);
                }
                thumbnailElement.dataset.label = file.name;
            }
        </script>
    </div>
</body>
</html>